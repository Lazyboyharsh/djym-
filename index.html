<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DJYM Cloud System (Supabase)</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Tinos:wght@400;700&display=swap');
        
        body { font-family: 'Tinos', serif; background-color: #f0f0f0; display: flex; flex-direction: column; align-items: center; padding: 10px; margin: 0; }
        
        /* LOGIN */
        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #2c3e50; z-index: 9999;
            display: flex; justify-content: center; align-items: center;
        }
        .login-box {
            background: white; padding: 30px; border-radius: 10px; text-align: center; width: 280px;
            font-family: 'Roboto', sans-serif; box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
        .login-input { width: 100%; padding: 10px; margin: 15px 0; font-size: 18px; text-align: center; box-sizing: border-box; }
        .login-btn { width: 100%; padding: 10px; background-color: #800000; color: white; border: none; font-size: 18px; cursor: pointer; }

        /* RECEIPT */
        .receipt-box { 
            width: 100%; max-width: 800px; background-color: #fff8e1; 
            border: 4px dashed #800000; padding: 20px; color: #800000; 
            position: relative; box-sizing: border-box; overflow: hidden;
        }
        .watermark {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-30deg);
            font-size: clamp(80px, 15vw, 150px); font-family: 'Roboto', sans-serif; font-weight: 900; 
            color: #800000; opacity: 0.08; z-index: 0; pointer-events: none; user-select: none;
        }
        .header, .row, .footer-row { position: relative; z-index: 2; }
        .header { text-align: center; margin-bottom: 20px; }
        .org-name { font-size: clamp(20px, 5vw, 32px); font-weight: 800; text-transform: uppercase; font-family: 'Roboto', sans-serif; }
        .logo { position: absolute; top: 10px; left: 10px; width: 90px; height: 90px; z-index: 10; }
        .logo img { width: 100%; height: 90px; }
        
        .row { display: flex; justify-content: space-between; flex-wrap: wrap; margin-bottom: 12px; font-size: 18px; font-weight: bold; gap: 10px; align-items: center; }
        input { border: none; background: transparent; border-bottom: 1px dotted #800000; font-family: 'Courier New', monospace; font-size: 18px; color: #000080; font-weight: bold; width: 100%; outline: none; }
        .input-group { flex-grow: 1; min-width: 200px; display: flex; align-items: center; }
        .input-group label { white-space: nowrap; margin-right: 10px; }

        /* Footer Layout */
        .footer-row { display: flex; justify-content: space-between; margin-top: 30px; flex-wrap: wrap; align-items: flex-end; }
        .amount-box { border: 2px solid #800000; border-radius: 10px; padding: 10px 20px; font-size: 24px; font-weight: bold; }
        
        /* Signature */
        .signature-area { text-align: center; width: 180px; }
        .sign-img { height: 90px; border-bottom: 1px solid #800000; margin-bottom: 5px; display:flex; align-items:flex-end; justify-content:center;}
        .sign-img img { max-height: 100%; max-width: 100%; }

        /* QR Code Area - Side by Side */
        .qr-area { 
            display: flex; 
            flex-direction: row; 
            align-items: center; 
            gap: 15px; 
            border: 1px dashed #800000; 
            padding: 5px 10px;
            border-radius: 8px;
            background: rgba(255,255,255,0.6);
        }
        #qrcode { 
            border: 2px solid #800000; 
            padding: 3px; 
            background: white; 
            flex-shrink: 0; 
        }
        .bank-details { 
            font-size: 11px; 
            font-weight: bold; 
            text-align: left; 
            line-height: 1.4;
        }

        /* Title Box */
        .title-box { 
            border: 2px solid #800000; padding: 5px 15px; border-radius: 20px; 
            font-weight: bold; font-family: 'Roboto', sans-serif; background: #fff;
            text-transform: uppercase; font-size: 14px;
        }

        /* CONTROLS */
        .controls { margin-top: 20px; width: 100%; max-width: 600px; display: flex; flex-direction: column; gap: 10px; }
        button { padding: 15px; font-size: 16px; color: white; border: none; cursor: pointer; border-radius: 8px; font-weight: bold; width: 100%; }
        
        .btn-db { background-color: #27ae60; } 
        .btn-hist { background-color: #2980b9; }
        .btn-reset { background-color: #7f8c8d; padding: 10px; font-size: 14px;}

        /* HISTORY TABLE */
        #historySection { display: none; margin-top: 20px; width: 100%; max-width: 800px; background: white; padding: 20px; border-radius: 10px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; min-width: 500px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #eee; }

        @media (max-width: 600px) {
            .logo { position: relative; top: 0; left: 0; margin: 0 auto 10px auto; display:block; }
            .row { flex-direction: column; align-items: flex-start; gap: 5px; }
            .footer-row { flex-direction: column; align-items: center; gap: 20px; }
            .top-row { flex-direction: column; align-items: center !important; gap: 10px; } 
            .top-row .input-group { width: 100%; justify-content: space-between; }
        }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="login-box">
            <h2 style="color:#800000; margin-top:0;">SECURE LOGIN</h2>
            <input type="password" id="passInput" class="login-input" placeholder="Enter Password">
            <button onclick="checkPassword()" class="login-btn">Unlock System</button>
            <div id="errorMsg" style="color:red; display:none; margin-top:10px;">‚ùå Incorrect Password</div>
        </div>
    </div>

    <div class="receipt-box" id="receipt">
        <div class="watermark">DJYM</div>
        <div class="logo"><img src="logo.png" onerror="this.style.display='none'"></div>

        <div class="header">
            <div style="font-size:14px; font-weight:bold;">!! Shri Mahaviraya Namah !!</div>
            <div class="org-name">DHARM JAGRITI YUVA MANDAL (DJYM)</div>
            <div style="font-weight:bold;">UTTAM NAGAR, NEW DELHI - 110059</div>
            <div style="font-weight:bold;">Contact No. : 9891432230</div>
        </div>

        <div class="row top-row" style="display: flex; justify-content: space-between; align-items: center;">
            <div class="input-group" style="flex-grow:0; width: auto;">
                <label>No.</label>
                <input type="text" id="slipNo" style="width:60px; text-align:center;" readonly>
            </div>
            
            <div class="title-box">Payment Receipt</div>

            <div class="input-group" style="flex-grow:0; width: auto; justify-content: flex-end;">
                <label>Dated</label>
                <input type="text" id="dateFieldDisplay" style="width: 120px; text-align: right;" placeholder="DD-MM-YYYY">
                <input type="date" id="datePicker" style="position:absolute; visibility:hidden;"> 
            </div>
        </div>

        <div class="row"><div class="input-group"><label>Received from M/s</label><input type="text" id="nameField"></div></div>
        <div class="row"><div class="input-group"><label>Address</label><input type="text" id="addrField"></div></div>
        <div class="row"><div class="input-group"><label>the sum of Rupees</label><input type="text" id="amountWords"></div></div>
        <div class="row"><div class="input-group"><label>Purpose</label><input type="text" id="purposeField" value="Annual Rashi"></div></div>

        <div class="row">
            <div class="input-group">
                <label>Mode of Payment</label>
                <input type="text" id="paymentMode" placeholder="Cash / UPI / Cheque No.">
            </div>
        </div>

        <div class="footer-row">
            <div class="amount-box">Rs. <input type="number" id="amountNum" placeholder="0" style="width:100px; border:none; font-size:24px;"> /-</div>
            
            <div class="qr-area">
                <div id="qrcode"></div>
                <div class="bank-details">
                    Bank: Axis Bank<br>
                    Name: Dharm Jagriti Yuva Mandal<br>
                    Acc No: 925020024236269<br>
                    IFSC: UTIB0003047
                </div>
            </div>

            <div class="signature-area">
                <div class="sign-img"><img src="sign.png" alt="Sign" onerror="this.style.display='none'"></div>
                <div>Receiver Signature</div>
            </div>
        </div>
    </div>

    <div class="controls">
        <button id="btnSave" class="btn-db" onclick="saveToCloudAndDownload()">‚òÅÔ∏è Save to Cloud & Download Image</button>
        
        <div style="display:flex; gap:10px; width:100%;">
            <button class="btn-hist" onclick="loadHistory()">üåç Load Global History</button>
            <button class="btn-reset" onclick="resetCounter()">‚ö†Ô∏è Reset No.</button>
        </div>
        <div id="statusMsg" style="text-align:center; font-weight:bold; margin-top:5px; height:20px;"></div>
    </div>

    <div id="historySection">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3>Global Database History</h3>
            <button class="btn-reset" style="width:auto;" onclick="document.getElementById('historySection').style.display='none'">Close</button>
        </div>
        <table>
            <thead><tr><th>No.</th><th>Name</th><th>Amount</th><th>Mode</th></tr></thead>
            <tbody id="historyBody"></tbody>
        </table>
    </div>

    <script>
        // ================= CONFIGURATION =================
        const MY_PASSWORD = "1234"; 

        // ‚ö†Ô∏è SUPABASE KEYS 
        const SUPABASE_URL = 'https://mfvfkvnkjtwydcmpxjot.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1mdmZrdm5ranR3eWRjbXB4am90Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyMzE2NzQsImV4cCI6MjA4MTgwNzY3NH0.lKe6UXzo80elnvGy2JU2scQQNUzrpTiygItJULo1VNo';
        
        // ‚ö†Ô∏è UPI ID FOR QR CODE
        const UPI_ID = "MAB.037215030470058@axisbank"; 
        // =================================================

        const { createClient } = supabase;
        const _supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        window.onload = function() {
            // Password Check
            document.getElementById("passInput").addEventListener("keyup", function(event) {
                if (event.key === "Enter") { checkPassword(); }
            });

            // Date Picker Logic
            const displayDate = document.getElementById("dateFieldDisplay");
            const realDate = document.getElementById("datePicker");

            displayDate.addEventListener('click', () => {
                try { realDate.showPicker(); } 
                catch (e) { realDate.focus(); }
            });

            realDate.addEventListener('change', (e) => {
                if(realDate.value) {
                    const parts = realDate.value.split("-"); 
                    displayDate.value = `${parts[2]}-${parts[1]}-${parts[0]}`; 
                }
            });

            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            realDate.value = `${yyyy}-${mm}-${dd}`;
            displayDate.value = `${dd}-${mm}-${yyyy}`;

            generateQR();
        };

        function checkPassword() {
            if (document.getElementById('passInput').value === MY_PASSWORD) {
                document.getElementById('loginOverlay').style.display = "none";
                initApp();
            } else {
                document.getElementById('errorMsg').style.display = "block";
            }
        }

        function generateQR() {
            const qrData = `upi://pay?pa=${UPI_ID}&pn=DJYM`;
            new QRCode(document.getElementById("qrcode"), {
                text: qrData,
                width: 65, 
                height: 65,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });
        }

        async function initApp() {
            const { data, error } = await _supabase
                .from('receipts')
                .select('slip_no')
                .order('id', { ascending: false })
                .limit(1);

            let nextNo = 1;
            if (data && data.length > 0) {
                nextNo = parseInt(data[0].slip_no) + 1;
            }
            document.getElementById('slipNo').value = String(nextNo).padStart(3, '0');
        }

        // --- SAVE TO SUPABASE + DOWNLOAD ---
        async function saveToCloudAndDownload() {
            const btn = document.getElementById('btnSave');
            const msg = document.getElementById('statusMsg');
            
            const name = document.getElementById('nameField').value;
            const amt = document.getElementById('amountNum').value;
            
            if(!name || !amt) { alert("Please fill Name and Amount!"); return; }

            // NEW: Get Single Payment Mode
            const modeInput = document.getElementById('paymentMode').value;
            const mode = modeInput.trim() !== "" ? modeInput : "Cash"; // Default to Cash if empty

            const slipNo = document.getElementById('slipNo').value;
            const dateStr = document.getElementById('dateFieldDisplay').value;

            btn.disabled = true;
            btn.innerText = "Saving to Database...";

            // 1. SAVE TO DATABASE
            const { error } = await _supabase
                .from('receipts')
                .insert({
                    slip_no: slipNo,
                    date: dateStr,
                    name: name,
                    address: document.getElementById('addrField').value,
                    words: document.getElementById('amountWords').value,
                    amount: amt,
                    mode: mode
                });

            if (error) {
                console.error(error);
                msg.innerText = "‚ùå Error Saving.";
                msg.style.color = "red";
                btn.disabled = false;
            } else {
                msg.innerText = "‚úÖ Saved! Downloading Image...";
                msg.style.color = "green";
                
                // 2. DOWNLOAD IMAGE (Wait for it to finish)
                await downloadImagePromise();

                // 3. CLEAR FORM & UPDATE
                document.getElementById('nameField').value = "";
                document.getElementById('addrField').value = "";
                document.getElementById('amountWords').value = "";
                document.getElementById('amountNum').value = "";
                document.getElementById('paymentMode').value = ""; // Clear the new input

                let newNo = parseInt(slipNo) + 1;
                document.getElementById('slipNo').value = String(newNo).padStart(3, '0');
                
                btn.disabled = false;
                btn.innerText = "‚òÅÔ∏è Save to Cloud & Download Image";
                setTimeout(() => msg.innerText = "", 3000);
            }
        }

        // Wrapper to make downloadImage await-able
        function downloadImagePromise() {
            return new Promise((resolve) => {
                const receipt = document.getElementById('receipt');
                const slipNo = document.getElementById('slipNo').value;
                const options = { scale: 2, backgroundColor: "#fff8e1", useCORS: true, windowWidth: 800, width: 800 };
                const originalWidth = receipt.style.width;
                receipt.style.width = "800px";
                
                html2canvas(receipt, options).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `Receipt_${slipNo}.png`;
                    link.href = canvas.toDataURL("image/png");
                    link.click();
                    receipt.style.width = originalWidth;
                    resolve(); // Signal done
                });
            });
        }

        async function loadHistory() {
            const section = document.getElementById('historySection');
            const tbody = document.getElementById('historyBody');
            section.style.display = "block";
            tbody.innerHTML = "<tr><td colspan='4'>Loading...</td></tr>";

            const { data, error } = await _supabase
                .from('receipts')
                .select('*')
                .order('id', { ascending: false })
                .limit(50);

            if (error) {
                alert("Error loading history");
                return;
            }

            tbody.innerHTML = "";
            data.forEach(item => {
                tbody.innerHTML += `<tr>
                    <td>${item.slip_no}</td>
                    <td>${item.name}</td>
                    <td>${item.amount}</td>
                    <td>${item.mode}</td>
                </tr>`;
            });
        }
        
        function resetCounter() {
            let newNum = prompt("Enter new Start Number:", "1");
            if(newNum) document.getElementById('slipNo').value = String(newNum).padStart(3, '0');
        }
    </script>
</body>
</html>