<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DJYM Secure Receipt</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Tinos:wght@400;700&display=swap');

        /* --- GLOBAL STYLES --- */
        body { font-family: 'Tinos', serif; background-color: #f0f0f0; display: flex; flex-direction: column; align-items: center; padding: 10px; margin: 0; }
        
        /* --- LOGIN SCREEN STYLES (NEW) --- */
        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #2c3e50; /* Dark Blue Background */
            z-index: 9999; /* Sit on top of everything */
            display: flex; justify-content: center; align-items: center;
        }
        .login-box {
            background: white; padding: 40px; border-radius: 10px;
            text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            width: 300px; font-family: 'Roboto', sans-serif;
        }
        .login-box h2 { margin-top: 0; color: #800000; }
        .login-input {
            width: 100%; padding: 10px; margin: 15px 0;
            font-size: 18px; text-align: center; border: 2px solid #ddd; border-radius: 5px;
            box-sizing: border-box;
        }
        .login-btn {
            width: 100%; padding: 10px; background-color: #800000; color: white;
            border: none; border-radius: 5px; font-size: 18px; cursor: pointer;
        }
        .login-btn:hover { background-color: #600000; }
        .error-msg { color: red; font-weight: bold; margin-top: 10px; display: none; }

        /* --- RECEIPT STYLES --- */
        .receipt-box { 
            width: 100%; max-width: 800px; background-color: #fff8e1; 
            border: 4px dashed #800000; padding: 20px; color: #800000; 
            position: relative; box-sizing: border-box; overflow: hidden;
        }

        /* Watermark */
        .watermark {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%) rotate(-30deg);
            font-size: clamp(80px, 15vw, 150px);
            font-family: 'Roboto', sans-serif; font-weight: 900; color: #800000;
            opacity: 0.08; z-index: 0; pointer-events: none; user-select: none; white-space: nowrap;
        }
        
        /* Header, Rows, etc. */
        .header, .row, .footer-row { position: relative; z-index: 2; }
        .header { text-align: center; margin-bottom: 20px; }
        .org-name { font-size: clamp(20px, 5vw, 32px); font-weight: 800; text-transform: uppercase; font-family: 'Roboto', sans-serif; }
        
        .logo { position: absolute; top: 10px; left: 10px; width: 60px; height: 60px; z-index: 10; }
        .logo img { width: 100%; height: auto; }

        .row { display: flex; justify-content: space-between; flex-wrap: wrap; margin-bottom: 12px; font-size: 18px; font-weight: bold; gap: 10px; }
        input { border: none; background: transparent; border-bottom: 1px dotted #800000; font-family: 'Courier New', monospace; font-size: 18px; color: #000080; font-weight: bold; width: 100%; outline: none; }
        .input-group { flex-grow: 1; min-width: 200px; display: flex; align-items: center; }
        .input-group label { white-space: nowrap; margin-right: 10px; }
        
        .footer-row { display: flex; justify-content: space-between; margin-top: 30px; flex-wrap: wrap; align-items: flex-end; }
        .amount-box { border: 2px solid #800000; border-radius: 10px; padding: 10px 20px; font-size: 24px; font-weight: bold; }
        
        .signature-area { text-align: center; width: 180px; }
        .sign-img { height: 50px; border-bottom: 1px solid #800000; margin-bottom: 5px; display:flex; align-items:flex-end; justify-content:center;}
        .sign-img img { max-height: 100%; max-width: 100%; }

        /* Controls */
        .controls { margin-top: 20px; width: 100%; max-width: 600px; display: flex; flex-direction: column; gap: 10px; }
        .btn-row { display: flex; gap: 10px; }
        button { padding: 15px; font-size: 16px; color: white; border: none; cursor: pointer; border-radius: 8px; font-weight: bold; width: 100%; }
        .btn-green { background-color: #27ae60; } 
        .btn-orange { background-color: #d35400; }
        .btn-blue { background-color: #2980b9; }
        .btn-gray { background-color: #7f8c8d; font-size: 14px; padding: 10px; }

        /* History */
        #historySection { display: none; margin-top: 20px; width: 100%; max-width: 800px; background: white; padding: 20px; border-radius: 10px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; min-width: 500px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #eee; }

        @media (max-width: 600px) {
            .logo { position: relative; top: 0; left: 0; margin: 0 auto 10px auto; display:block; }
            .row { flex-direction: column; align-items: flex-start; gap: 5px; }
            .footer-row { flex-direction: column; align-items: center; gap: 20px; }
            .btn-row { flex-direction: column; }
        }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="login-box">
            <h2>DJYM Login</h2>
            <p>Please enter password to access</p>
            <input type="password" id="passInput" class="login-input" placeholder="Password">
            <button onclick="checkPassword()" class="login-btn">Unlock</button>
            <div id="errorMsg" class="error-msg">‚ùå Wrong Password</div>
        </div>
    </div>

    <div class="receipt-box" id="receipt">
        <div class="watermark">DJYM</div>
        <div class="logo"><img src="logo.png" onerror="this.style.display='none'"></div>

        <div class="header">
            <div style="font-size:14px; font-weight:bold;">!! Shri Mahaviraya Namah !!</div>
            <div class="org-name">DHARAM JAGRITI YUVA MANDAL (DJYM)</div>
            <div style="font-weight:bold;">UTTAM NAGAR, NEW DELHI - 110059</div>
            <div style="font-weight:bold;">Contact No. : 9810765996, 9975080760</div>
        </div>

        <div class="row">
            <div class="input-group" style="flex-grow:0;">
                <label>No.</label>
                <input type="text" id="slipNo" style="width:80px; text-align:center;" readonly>
            </div>
            <div class="input-group" style="justify-content: flex-end;">
                <label>Dated</label>
                <input type="date" id="dateField">
            </div>
        </div>

        <div class="row"><div class="input-group"><label>Received from M/s</label><input type="text" id="nameField"></div></div>
        <div class="row"><div class="input-group"><label>Address</label><input type="text" id="addrField"></div></div>
        <div class="row"><div class="input-group"><label>the sum of Rupees</label><input type="text" id="amountWords"></div></div>
        <div class="row"><div class="input-group"><label>Purpose</label><input type="text" id="purposeField" value="Annual Rashi"></div></div>

        <div class="row">
            <div class="input-group" style="flex-grow:0;">
                <label>Cash</label>
                <input type="text" style="width:60px;" value="Cash">
            </div>
            <div class="input-group">
                <label>Online Txn</label>
                <input type="text" id="modeOnline" placeholder="UPI / Ref No">
            </div>
        </div>

        <div class="footer-row">
            <div class="amount-box">Rs. <input type="number" id="amountNum" placeholder="0" style="width:100px; border:none; font-size:24px;"> /-</div>
            <div class="signature-area">
                <div class="sign-img"><img src="sign.png" alt="Sign" onerror="this.style.display='none'"></div>
                <div>Receiver Signature</div>
            </div>
        </div>
    </div>

    <div class="controls">
        <button class="btn-orange" onclick="downloadImage()">üì∏ Download Receipt Image</button>
        <button class="btn-green" onclick="generateNextSlip()">‚û°Ô∏è Next Slip (Save & Clear)</button>
        <div class="btn-row">
            <button class="btn-blue" onclick="toggleHistory()">üìú View History</button>
            <button class="btn-gray" onclick="resetCounter()">‚ö†Ô∏è Set Start Number</button>
        </div>
    </div>

    <div id="historySection">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3>Saved History</h3>
            <button class="btn-gray" style="width:auto;" onclick="exportCSV()">‚¨áÔ∏è Download Excel/CSV</button>
        </div>
        <table>
            <thead><tr><th>No.</th><th>Name</th><th>Amount</th><th>Mode</th></tr></thead>
            <tbody id="historyBody"></tbody>
        </table>
    </div>

    <script>
        // **********************************************
        // üîë SET YOUR PASSWORD HERE:
        const MY_PASSWORD = "1234";
        // **********************************************

        window.onload = function() {
            // Wait for password check before loading sensitive data
            // loadSlipNumber(); 
            // document.getElementById('dateField').value = new Date().toISOString().split('T')[0];
            
            // Allow "Enter" key to submit password
            document.getElementById("passInput").addEventListener("keyup", function(event) {
                if (event.key === "Enter") { checkPassword(); }
            });
        };

        // --- PASSWORD FUNCTION ---
        function checkPassword() {
            const input = document.getElementById('passInput').value;
            const overlay = document.getElementById('loginOverlay');
            const error = document.getElementById('errorMsg');

            if (input === MY_PASSWORD) {
                // Unlock!
                overlay.style.display = "none";
                // Now load the app data
                loadSlipNumber();
                document.getElementById('dateField').value = new Date().toISOString().split('T')[0];
                renderHistoryTable();
            } else {
                // Wrong password
                error.style.display = "block";
                document.getElementById('passInput').value = "";
            }
        }

        // --- APP LOGIC (Same as before) ---
        
        function generateNextSlip() {
            const onlineVal = document.getElementById('modeOnline').value;
            const mode = onlineVal.trim() !== "" ? "Online (" + onlineVal + ")" : "Cash";
            const name = document.getElementById('nameField').value;
            const amt = document.getElementById('amountNum').value;

            if(name) {
                const data = {
                    no: document.getElementById('slipNo').value,
                    date: document.getElementById('dateField').value,
                    name: name,
                    amount: amt,
                    mode: mode
                };
                let history = JSON.parse(localStorage.getItem('djym_history') || "[]");
                history.unshift(data);
                localStorage.setItem('djym_history', JSON.stringify(history));
            }

            let current = parseInt(localStorage.getItem('djym_slip_counter') || 1);
            localStorage.setItem('djym_slip_counter', current + 1);
            loadSlipNumber();

            document.getElementById('nameField').value = "";
            document.getElementById('addrField').value = "";
            document.getElementById('amountWords').value = "";
            document.getElementById('amountNum').value = "";
            document.getElementById('modeOnline').value = "";
            renderHistoryTable();
            alert("Saved! Ready for next slip.");
        }

        function downloadImage() {
            const receipt = document.getElementById('receipt');
            const slipNo = document.getElementById('slipNo').value;
            html2canvas(receipt, { scale: 2, backgroundColor: "#fff8e1", useCORS: true }).then(canvas => {
                const link = document.createElement('a');
                link.download = `Receipt_${slipNo}.png`;
                link.href = canvas.toDataURL("image/png");
                link.click();
            });
        }

        function resetCounter() {
            let newNum = prompt("Enter the starting Slip Number (e.g. 1):", "");
            if (newNum && !isNaN(newNum)) {
                localStorage.setItem('djym_slip_counter', parseInt(newNum));
                loadSlipNumber();
            }
        }

        function exportCSV() {
            const history = JSON.parse(localStorage.getItem('djym_history') || "[]");
            let csvContent = "data:text/csv;charset=utf-8,No,Date,Name,Amount,Mode\n";
            history.forEach(row => {
                csvContent += `${row.no},${row.date},"${row.name}",${row.amount},"${row.mode}"\n`;
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "DJYM_History.csv");
            document.body.appendChild(link);
            link.click();
        }

        function loadSlipNumber() {
            let val = localStorage.getItem('djym_slip_counter') || 1;
            document.getElementById('slipNo').value = String(val).padStart(3, '0');
        }

        function toggleHistory() {
            const el = document.getElementById('historySection');
            el.style.display = (el.style.display === 'block') ? 'none' : 'block';
        }

        function renderHistoryTable() {
            const history = JSON.parse(localStorage.getItem('djym_history') || "[]");
            const tbody = document.getElementById('historyBody');
            tbody.innerHTML = "";
            history.forEach(item => {
                tbody.innerHTML += `<tr><td>${item.no}</td><td>${item.name}</td><td>${item.amount}</td><td>${item.mode}</td></tr>`;
            });
        }
    </script>
</body>
</html>